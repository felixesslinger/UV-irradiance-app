<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UV Irradiance Rectangular Volume – App4 (cm units + converter)</title>
  <style>
    :root{--bg:#0b0c10;--panel:#12151b;--ink:#e6e9ef;--muted:#9aa4b2;--accent222:#6A3D9A;--accent275:#F781BF;--grid:#1d2330}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:clamp(20px,2.6vw,30px);margin:0 0 12px;font-weight:700}
    .sub{color:var(--muted);margin-bottom:20px}
    .layout{display:grid;grid-template-columns:380px 1fr;gap:16px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid #202532;border-radius:16px;box-shadow:0 1px 0 #000 inset,0 10px 30px rgba(0,0,0,.25)}
    .panel h2{font-size:16px;margin:0 0 8px}
    .pane-body{padding:16px}
    .controls{display:grid;gap:14px}
    .row{display:grid;gap:8px}
    .row.inline{grid-template-columns:1fr auto;align-items:center}
    .label{font-weight:600}
    .muted{color:var(--muted);font-size:12px}
    .seg{display:flex;gap:8px}
    .seg button{flex:1;padding:10px 12px;border-radius:12px;border:1px solid #2a3242;background:#151a23;color:var(--ink);cursor:pointer;font-weight:700}
    .seg button.active[data-wl="222"]{outline:2px solid var(--accent222)}
    .seg button.active[data-wl="275"]{outline:2px solid var(--accent275)}
    .slider{appearance:none;width:100%;height:4px;border-radius:999px;background:linear-gradient(90deg,#2a3242,#3a4458)}
    .slider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#e6e9ef;border:2px solid #141821;cursor:pointer}
    .val{font-variant-numeric:tabular-nums}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#141821;border:1px solid #2a3242;color:var(--muted);font-size:12px}
    .viz-head{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid #1a2030}
    .viz{display:grid;grid-template-columns:1fr 300px;gap:16px}
    @media (max-width:980px){.viz{grid-template-columns:1fr}}
    canvas{width:100%;height:auto;border-bottom-left-radius:16px;border-bottom-right-radius:16px;display:block;background:radial-gradient(circle at 50% 0%, rgba(255,255,255,.04), rgba(255,255,255,0) 40%), repeating-linear-gradient(0deg, var(--grid), var(--grid) 1px, transparent 1px, transparent 24px), repeating-linear-gradient(90deg, var(--grid), var(--grid) 1px, transparent 1px, transparent 24px)}
    .legend{padding:8px 16px 16px}
    .scale{height:14px;border-radius:8px;background:linear-gradient(90deg,#0b0c10,#27324a,#3b5c8a,#61a5d9,#b7e0ff)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .card{padding:12px;border:1px solid #1a2030;border-radius:12px;background:#0f131a}
    .foot{color:var(--muted);font-size:12px;padding:12px 16px;border-top:1px solid #1a2030}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0e1220;border:1px solid #2a3242;border-bottom-color:#1a2232;padding:2px 6px;border-radius:6px}
    .toggle{display:flex;gap:10px;align-items:center}
    .input-group{display:grid;grid-template-columns:1fr 92px;gap:8px;align-items:center}
    .num{width:100%;background:#141821;border:1px solid #2a3242;border-radius:10px;color:var(--ink);padding:8px 10px;font-variant-numeric:tabular-nums}
    .span-2{grid-column:1 / -1}
    /* Tooltip */
    .tooltip{position:relative;display:inline-block;cursor:help}
    .tooltip .tooltiptext{visibility:hidden;min-width:220px;max-width:320px;background:#333;color:#fff;text-align:left;border-radius:8px;padding:8px;position:absolute;z-index:2;bottom:125%;left:0;opacity:0;transform:translateY(4px);transition:opacity .2s,transform .2s;font-size:12px;line-height:1.3}
    .tooltip:hover .tooltiptext{visibility:visible;opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>UV Irradiance in a Rectangular System</h1>
    <p class="sub">Chamber dimensions and z-plane are now in <b>centimeters</b>. Internally, physics is computed in meters. Explore irradiance and dose, switch lamps (222/275&nbsp;nm), set power, time, dimensions, and physics parameters.</p>

    <div class="layout">
      <!-- Controls -->
      <div class="panel">
        <div class="pane-body">
          <h2>Controls</h2>
          <div class="controls">
            <div class="row">
              <div class="label">Lamp wavelength</div>
              <div class="seg">
                <button id="wl222" data-wl="222" class="active">222 nm</button>
                <button id="wl275" data-wl="275">275 nm</button>
              </div>
              <div class="muted">Switching wavelength affects color & presets; physics is generic unless you change parameters.</div>
            </div>

            <div class="row">
              <label class="label tooltip" for="flux">Radiant flux per lamp (<span class="pill">mW</span>)
                <span class="tooltiptext">Total radiant power per lamp. Sets absolute scale of irradiance.</span>
              </label>
              <div class="input-group">
                <input id="flux" class="slider" type="range" min="1" max="1000" step="0.5" value="15" />
                <input id="fluxNum" class="num" type="number" min="1" max="1000" step="0.5" value="15" />
              </div>
            </div>

            <div class="row">
              <label class="label tooltip" for="duration">Exposure duration (<span class="pill">s</span>)
                <span class="tooltiptext">Exposure time in seconds. Dose = irradiance × time (mJ/cm²).</span>
              </label>
              <div class="input-group">
                <input id="duration" class="slider" type="range" min="1" max="3600" step="1" value="60" />
                <input id="durationNum" class="num" type="number" min="1" max="3600" step="1" value="60" />
              </div>
            </div>

            <div class="row">
              <label class="label tooltip" for="lenX">Room length X (<span class="pill">cm</span>)
                <span class="tooltiptext">Length along X-axis. Heatmap aspect follows X:Y.</span>
              </label>
              <div class="input-group">
                <input id="lenX" class="slider" type="range" min="5" max="50" step="0.5" value="15" />
                <input id="lenXNum" class="num" type="number" min="5" max="50" step="0.5" value="15" />
              </div>
            </div>

            <div class="row">
              <label class="label tooltip" for="lenY">Room width Y (<span class="pill">cm</span>)
                <span class="tooltiptext">Width along Y-axis. Heatmap aspect follows X:Y.</span>
              </label>
              <div class="input-group">
                <input id="lenY" class="slider" type="range" min="5" max="50" step="0.5" value="15" />
                <input id="lenYNum" class="num" type="number" min="5" max="50" step="0.5" value="15" />
              </div>
            </div>

            <div class="row">
              <label class="label tooltip" for="lenZ">Room height Z (<span class="pill">cm</span>)
                <span class="tooltiptext">Room height. The sampling plane z must be ≤ this value.</span>
              </label>
              <div class="input-group">
                <input id="lenZ" class="slider" type="range" min="5" max="50" step="0.5" value="15" />
                <input id="lenZNum" class="num" type="number" min="5" max="50" step="0.5" value="15" />
              </div>
            </div>

            <div class="row">
              <label class="label tooltip" for="plane">Sampling plane height z (<span class="pill">cm above floor</span>)
                <span class="tooltiptext">Height of the 2D slice for the heatmap (in cm). Click in the heatmap to probe E & D at this z.</span>
              </label>
              <div class="input-group">
                <input id="plane" class="slider" type="range" min="0" max="50" step="0.5" value="7.5" />
                <input id="planeNum" class="num" type="number" min="0" max="50" step="0.5" value="7.5" />
              </div>
            </div>

            <div class="row">
              <label class="label tooltip" for="lamps"># Lamps
                <span class="tooltiptext">Number of lamps. In the center layout, values > 1 switch to four corners.</span>
              </label>
              <div class="input-group">
                <input id="lamps" class="slider" type="range" min="1" max="4" step="1" value="1" />
                <input id="lampsNum" class="num" type="number" min="1" max="4" step="1" value="1" />
              </div>
            </div>

            <div class="row">
              <div class="label">Lamp layout</div>
              <div class="seg">
                <button id="layout-center" class="active">Ceiling center</button>
                <button id="layout-corners">4 corners (ceiling)</button>
              </div>
            </div>

            <div class="row">
              <label class="label tooltip" for="att">Attenuation \(lpha\) (<span class="pill">1/m</span>)
                <span class="tooltiptext">Exponential loss exp(-α·r) per meter due to absorption/scattering.</span>
              </label>
              <div class="input-group">
                <input id="att" class="slider" type="range" min="0" max="1.0" step="0.01" value="0.00" />
                <input id="attNum" class="num" type="number" min="0" max="1.0" step="0.01" value="0.00" />
              </div>
            </div>

            <div class="row">
              <label class="label tooltip" for="refl">Wall reflectance factor
                <span class="tooltiptext">First-order multiplier to mimic wall bounce. 1.00× = no reflectance.</span>
              </label>
              <div class="input-group">
                <input id="refl" class="slider" type="range" min="1" max="2" step="0.01" value="1.00" />
                <input id="reflNum" class="num" type="number" min="1" max="2" step="0.01" value="1.00" />
              </div>
            </div>

            <div class="row toggle">
              <input type="checkbox" id="normalize" checked />
              <label for="normalize" class="tooltip">Auto color-scale to 95th percentile (robust)
                <span class="tooltiptext">Prevents outliers from dominating the color scale.</span>
              </label>
            </div>

            <div class="row">
              <div class="muted">Tip: Click the heatmap to move the probe and read local irradiance & dose. Units: irradiance in <span class="kbd">mW/m²</span>, dose in <span class="kbd">mJ/cm²</span>. Geometry units: <b>cm</b>.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Visualization -->
      <div class="panel">
        <div class="viz-head">
          <div>
            <div class="pill" id="wlPill">222 nm</div>
            <div class="muted">Sampling plane (top-down). Axes are centimeters (0 → X_cm, 0 → Y_cm). Aspect reflects X:Y.</div>
          </div>
          <div class="pill">Model: point source + exp(-\(lpha r\)) · reflectance factor</div>
        </div>
        <div class="viz">
          <div>
            <canvas id="cnv" width="640" height="640" aria-label="Irradiance heatmap"></canvas>
            <div class="legend">
              <div class="grid" style="align-items:start">
                <div>
                  <div class="label" style="margin-bottom:6px">Color scale</div>
                  <div class="scale" id="scaleBar"></div>
                </div>
                <div>
                  <div class="grid">
                    <div class="card">
                      <div class="muted">Probe (x,y,z) <b>cm</b></div>
                      <div class="val" id="probeXYZ">(7.50, 7.50, 7.50)</div>
                      <div class="muted">E irradiance</div>
                      <div class="val" id="probeE">–</div>
                      <div class="muted">Dose (E×t)</div>
                      <div class="val" id="probeD">–</div>
                    </div>
                    <div class="card">
                      <div class="muted">Plane stats (z-slice)</div>
                      <div class="val" id="stats">–</div>
                    </div>
                    <div class="card">
                      <div class="muted">Summary</div>
                      <div class="val" id="summary">–</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="foot">Assumptions: isotropic point emitters at ceiling nodes; no occlusion; simple reflectance multiplier; dose = irradiance × time. For design/validation, use radiometry of your actual setup.</div>
          </div>
          <div class="pane-body" style="border-left:1px solid #1a2030">
            <h2>Lamp positions (z = ceiling)</h2>
            <div id="lampList" class="grid"></div>
            <div style="height:12px"></div>
            <h2>Notes</h2>
            <ul class="muted">
              <li>Chamber geometry in <b>cm</b>, physics in SI units internally.</li>
              <li>Use <b>Radiant flux per lamp</b> to match your hardware.</li>
              <li>Increase <b>Attenuation</b> to mimic losses (e.g., window, mesh, aerosol path).</li>
              <li><b>Reflectance</b> multiplies the field to emulate wall bounce (first-order effect only).</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Unit Converter Panel (spans both columns) -->
      <div class="panel span-2">
        <div class="pane-body">
          <h2>Unit converter</h2>
          <p class="muted">Convert between common irradiance and dose units. You can also pull the current probe values.</p>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px;">
            <!-- Irradiance converter -->
            <div class="card" style="background:#0f131a">
              <h3 style="margin:0 0 8px;font-size:15px">Irradiance</h3>
              <div class="row" style="grid-template-columns:1fr 140px 110px;align-items:center">
                <label class="label" for="irrVal">Input value</label>
                <input id="irrVal" class="num" type="number" step="0.0001" value="1.0" />
                <select id="irrUnit" class="num" style="height:36px">
                  <option>W/m²</option>
                  <option>mW/m²</option>
                  <option>μW/m²</option>
                  <option>mW/cm²</option>
                  <option>μW/cm²</option>
                </select>
              </div>
              <div style="display:flex; gap:8px; margin:8px 0 12px; flex-wrap:wrap">
                <button id="useProbeE" class="seg" style="padding:8px 10px;border-radius:10px;border:1px solid #2a3242;background:#151a23;color:var(--ink);cursor:pointer">Use probe E</button>
                <button id="usePlaneMeanE" class="seg" style="padding:8px 10px;border-radius:10px;border:1px solid #2a3242;background:#151a23;color:var(--ink);cursor:pointer">Use plane mean E</button>
              </div>
              <div id="irrOut" class="muted"></div>
            </div>

            <!-- Dose converter -->
            <div class="card" style="background:#0f131a">
              <h3 style="margin:0 0 8px;font-size:15px">Dose</h3>
              <div class="row" style="grid-template-columns:1fr 140px 110px;align-items:center">
                <label class="label" for="doseVal">Input value</label>
                <input id="doseVal" class="num" type="number" step="0.0001" value="1.0" />
                <select id="doseUnit" class="num" style="height:36px">
                  <option>J/m²</option>
                  <option>mJ/m²</option>
                  <option>J/cm²</option>
                  <option>mJ/cm²</option>
                  <option>μJ/cm²</option>
                </select>
              </div>
              <div style="display:flex; gap:8px; margin:8px 0 12px; flex-wrap:wrap">
                <button id="useProbeD" class="seg" style="padding:8px 10px;border-radius:10px;border:1px solid #2a3242;background:#151a23;color:var(--ink);cursor:pointer">Use probe dose</button>
                <button id="usePlaneMeanD" class="seg" style="padding:8px 10px;border-radius:10px;border:1px solid #2a3242;background:#151a23;color:var(--ink);cursor:pointer">Use plane mean dose</button>
                <button id="useChamberMeanD" class="seg" style="padding:8px 10px;border-radius:10px;border:1px solid #2a3242;background:#151a23;color:var(--ink);cursor:pointer">Use chamber mean dose</button>
              </div>
              <div id="doseOut" class="muted"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // --- State --- (geometry in cm)
    const state = {
      wl: 222,
      flux_mW: 15,
      duration_s: 60,
      Lx_cm: 15.0,
      Ly_cm: 15.0,
      Lz_cm: 15.0,
      plane_z_cm: 7.5,
      nLamps: 1,
      layout: 'center', // 'center' | 'corners'
      alpha: 0.0,       // 1/m (SI)
      reflectance: 1.0, // multiplier
      probe_cm: { x: 7.5, y: 7.5 },
      normalize: true,
    };

    const presets = { 222: { flux_mW: 15 }, 275: { flux_mW: 30 } };

    // Elements
    const el = {
      wl222: document.getElementById('wl222'),
      wl275: document.getElementById('wl275'),
      wlPill: document.getElementById('wlPill'),
      flux: document.getElementById('flux'),
      fluxNum: document.getElementById('fluxNum'),
      duration: document.getElementById('duration'),
      durationNum: document.getElementById('durationNum'),
      lenX: document.getElementById('lenX'), lenXNum: document.getElementById('lenXNum'),
      lenY: document.getElementById('lenY'), lenYNum: document.getElementById('lenYNum'),
      lenZ: document.getElementById('lenZ'), lenZNum: document.getElementById('lenZNum'),
      plane: document.getElementById('plane'), planeNum: document.getElementById('planeNum'),
      lamps: document.getElementById('lamps'), lampsNum: document.getElementById('lampsNum'),
      layoutCenter: document.getElementById('layout-center'),
      layoutCorners: document.getElementById('layout-corners'),
      att: document.getElementById('att'), attNum: document.getElementById('attNum'),
      refl: document.getElementById('refl'), reflNum: document.getElementById('reflNum'),
      normalize: document.getElementById('normalize'),
      lampList: document.getElementById('lampList'),
      cnv: document.getElementById('cnv'),
      scaleBar: document.getElementById('scaleBar'),
      probeXYZ: document.getElementById('probeXYZ'),
      probeE: document.getElementById('probeE'),
      probeD: document.getElementById('probeD'),
      stats: document.getElementById('stats'),
      summary: document.getElementById('summary'),
    };

    // Canvas
    const ctx = el.cnv.getContext('2d');
    const BASE_N = 180; // base resolution per longer side (plane)

    const fmt = { num: (v,d=2)=>Number(v).toFixed(d) };
    const cm2m = v=> v/100.0;

    function setWL(wl){
      state.wl = wl;
      document.documentElement.style.setProperty('--accentCurrent', wl===222? getCSS('--accent222') : getCSS('--accent275'));
      state.flux_mW = presets[wl].flux_mW;
      syncPair(el.flux, el.fluxNum, state.flux_mW);
      el.wlPill.textContent = wl+" nm";
      el.wl222.classList.toggle('active', wl===222);
      el.wl275.classList.toggle('active', wl===275);
      draw();
    }

    function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name); }

    function lampPositions(){
      // convert to meters for physics
      const Lx = cm2m(state.Lx_cm), Ly = cm2m(state.Ly_cm), Lz = cm2m(state.Lz_cm);
      if(state.layout==='center') return [{x:Lx/2, y:Ly/2, z:Lz}];
      const corners = [
        {x:0,   y:0,   z:Lz},
        {x:Lx,  y:0,   z:Lz},
        {x:0,   y:Ly,  z:Lz},
        {x:Lx,  y:Ly,  z:Lz},
      ];
      return corners.slice(0, state.nLamps);
    }

    // E = sum Phi/(4π r^2) * exp(-alpha r)
    function irradianceAt(x_m,y_m,z_m){
      const alpha = state.alpha;     // 1/m
      const Phi = state.flux_mW;     // mW per lamp
      let E = 0;
      for(const Lp of lampPositions()){
        const dx = x_m - Lp.x, dy = y_m - Lp.y, dz = z_m - Lp.z;
        const r2 = dx*dx + dy*dy + dz*dz;
        const r = Math.sqrt(r2);
        if(r < 1e-9) continue; // avoid singularity
        const Inv = 1.0 / (4*Math.PI*r2);
        const atten = Math.exp(-alpha*r);
        E += Phi * Inv * atten; // mW/m^2
      }
      E *= state.reflectance;
      return E;
    }

    function gridResolution(){
      const longer = Math.max(state.Lx_cm, state.Ly_cm);
      const Nx = Math.max(64, Math.round(BASE_N * (state.Lx_cm/longer)));
      const Ny = Math.max(64, Math.round(BASE_N * (state.Ly_cm/longer)));
      return {Nx, Ny};
    }

    function computeField(){
      const Lx_cm = state.Lx_cm, Ly_cm = state.Ly_cm;
      const z_m = cm2m(state.plane_z_cm);
      const {Nx,Ny} = gridResolution();
      const arr = new Float64Array(Nx*Ny);
      let i=0;
      for(let jy=0;jy<Ny;jy++){
        const y_cm = Ly_cm * (jy+0.5)/Ny;
        for(let ix=0;ix<Nx;ix++){
          const x_cm = Lx_cm * (ix+0.5)/Nx;
          arr[i++] = irradianceAt(cm2m(x_cm), cm2m(y_cm), z_m);
        }
      }
      return {arr, Nx, Ny};
    }

    function percentile(arr, p){
      const a = Array.from(arr).sort((a,b)=>a-b);
      const idx = Math.min(a.length-1, Math.max(0, Math.round((p/100)*a.length)-1));
      return a[idx];
    }

    function draw(){
      // Adjust canvas pixel size to maintain X:Y aspect (in cm)
      resizeCanvasToAspect();

      const {arr, Nx, Ny} = computeField();

      let vmin = 0;
      let vmax = state.normalize ? percentile(arr, 95) : Math.max(...arr);
      if(vmax<=0) vmax = 1e-9;

      const img = ctx.createImageData(Nx, Ny);
      for(let i=0;i<arr.length;i++){
        const v = Math.max(0, Math.min(1, (arr[i]-vmin)/(vmax-vmin)));
        const c = palette(v);
        img.data[i*4+0]=c[0]; img.data[i*4+1]=c[1]; img.data[i*4+2]=c[2]; img.data[i*4+3]=255;
      }
      const tmp = document.createElement('canvas');
      tmp.width=Nx; tmp.height=Ny; tmp.getContext('2d').putImageData(img,0,0);
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(tmp, 0, 0, el.cnv.width, el.cnv.height);

      drawAxes();
      drawProbe();
      updateLegend(vmin, vmax);
      updateStats(arr);
      updateLampList();
      updateProbeReadout();
      updateSummary();
    }

    function drawAxes(){
      const w = el.cnv.width, h = el.cnv.height;
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.2)';
      ctx.lineWidth = 1;
      const ticks = 5;
      for(let i=0;i<=ticks;i++){
        const x = Math.round((i/ticks)*w);
        const y = Math.round((i/ticks)*h);
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.restore();
    }

    function drawProbe(){
      const w = el.cnv.width, h = el.cnv.height;
      const px = state.probe_cm.x/state.Lx_cm * w;
      const py = state.probe_cm.y/state.Ly_cm * h;
      ctx.save();
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(px-8,py); ctx.lineTo(px+8,py); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(px,py-8); ctx.lineTo(px,py+8); ctx.stroke();
      ctx.restore();
    }

    function updateLegend(vmin, vmax){
      const bar = el.scaleBar;
      bar.style.background = 'linear-gradient(90deg,#0b0c10,#27324a,#3b5c8a,#61a5d9,#b7e0ff)';
      const statsTxt = `min ${fmt.num(vmin,3)} · max ${fmt.num(vmax,3)} mW/m²`;
      bar.setAttribute('title', statsTxt);
    }

    function updateStats(arr){
      let sum=0, min=Infinity, max=-Infinity;
      for(const v of arr){ sum+=v; if(v<min)min=v; if(v>max)max=v; }
      const mean = sum/arr.length;
      const t = state.duration_s;
      const D_avg = (mean * t) / 10000.0; // mJ/cm²
      el.stats.textContent = `E_avg ${fmt.num(mean,3)} mW/m² · E_min ${fmt.num(min,3)} · E_max ${fmt.num(max,3)} | Dose_avg ${fmt.num(D_avg,3)} mJ/cm²`;
    }

    function updateLampList(){
      const lamps = lampPositions();
      const wl = state.wl;
      const clr = (wl===222)? getCSS('--accent222') : getCSS('--accent275');
      el.lampList.innerHTML = lamps.map((p,i)=>{
        return `<div class="card"><div class="muted">Lamp ${i+1}</div><div class="val">(${fmt.num(p.x,2)}, ${fmt.num(p.y,2)}, ${fmt.num(p.z,2)}) m</div><div class="pill" style="border-color:${clr};color:${clr}">${state.wl} nm · ${fmt.num(state.flux_mW,1)} mW</div></div>`
      }).join('');
    }

    function updateProbeReadout(){
      const x_cm = state.probe_cm.x, y_cm = state.probe_cm.y, z_cm = state.plane_z_cm;
      const E = irradianceAt(cm2m(x_cm), cm2m(y_cm), cm2m(z_cm));
      const D = (E * state.duration_s) / 10000.0; // mJ/cm^2
      el.probeXYZ.textContent = `(${fmt.num(x_cm,2)}, ${fmt.num(y_cm,2)}, ${fmt.num(z_cm,2)})`;
      el.probeE.textContent = `${fmt.num(E,4)} mW/m²`;
      el.probeD.textContent = `${fmt.num(D,4)} mJ/cm²`;
    }

    // 3D chamber mean irradiance (numerical sampling) — geometry in cm, physics in m
    function chamberMeanIrradiance(){
      const Lx_cm = state.Lx_cm, Ly_cm = state.Ly_cm, Lz_cm = state.Lz_cm;
      const Nx = 24, Ny = 24, Nz = 12; // balanced speed/quality
      let sum=0, n=0;
      for(let kz=0;kz<Nz;kz++){
        const z_cm = Lz_cm * (kz+0.5)/Nz;
        for(let jy=0;jy<Ny;jy++){
          const y_cm = Ly_cm * (jy+0.5)/Ny;
          for(let ix=0;ix<Nx;ix++){
            const x_cm = Lx_cm * (ix+0.5)/Nx;
            sum += irradianceAt(cm2m(x_cm), cm2m(y_cm), cm2m(z_cm));
            n++;
          }
        }
      }
      return sum/n; // mW/m²
    }

    function updateSummary(){
      const E_vol_avg = chamberMeanIrradiance();
      const t = state.duration_s;
      const D_vol_avg = (E_vol_avg * t) / 10000.0; // mJ/cm²
      el.summary.textContent = `Chamber mean irradiance: ${fmt.num(E_vol_avg,3)} mW/m² · Chamber mean dose: ${fmt.num(D_vol_avg,3)} mJ/cm²`;
    }

    function palette(t){
      const stops = [
        [0,   11,  12,  16],
        [0.25, 39,  50,  74],
        [0.50, 59,  92, 138],
        [0.75, 97, 165, 217],
        [1.0, 183, 224, 255]
      ];
      for(let i=1;i<stops.length;i++){
        if(t<=stops[i][0]){
          const [t0,r0,g0,b0] = stops[i-1];
          const [t1,r1,g1,b1] = stops[i];
          const u = (t - t0)/(t1 - t0);
          const r = Math.round(r0 + u*(r1-r0));
          const g = Math.round(g0 + u*(g1-g0));
          const b = Math.round(b0 + u*(b1-b0));
          return [r,g,b];
        }
      }
      return [183,224,255];
    }

    // --- Slider/Number sync helpers ---
    function syncPair(slider, number, val){ slider.value = val; number.value = val; }
    function bindPair(slider, number, onChange){
      slider.addEventListener('input', e=>{ number.value = e.target.value; onChange(+e.target.value); });
      number.addEventListener('input', e=>{ let v=+e.target.value; if(isNaN(v)) return; const min=+number.min, max=+number.max; if(!isNaN(min)) v=Math.max(min,v); if(!isNaN(max)) v=Math.min(max,v); slider.value = v; onChange(v); });
    }

    // Events
    el.wl222.addEventListener('click', ()=> setWL(222));
    el.wl275.addEventListener('click', ()=> setWL(275));

    bindPair(el.flux, el.fluxNum, v=>{ state.flux_mW = v; draw(); });
    bindPair(el.duration, el.durationNum, v=>{ state.duration_s = v; updateProbeReadout(); updateSummary(); updateStats(computeField().arr); });

    bindPair(el.lenX, el.lenXNum, v=>{ state.Lx_cm = v; constrainProbe(); draw(); });
    bindPair(el.lenY, el.lenYNum, v=>{ state.Ly_cm = v; constrainProbe(); draw(); });
    bindPair(el.lenZ, el.lenZNum, v=>{ state.Lz_cm = v; fitPlaneMax(); draw(); });

    bindPair(el.plane, el.planeNum, v=>{ state.plane_z_cm = Math.min(v, state.Lz_cm); el.plane.value = state.plane_z_cm; el.planeNum.value = state.plane_z_cm; draw(); });

    bindPair(el.lamps, el.lampsNum, v=>{ state.nLamps = Math.round(v); el.lamps.value = state.nLamps; el.lampsNum.value = state.nLamps; if(state.layout==='center' && state.nLamps>1){ state.layout='corners'; el.layoutCenter.classList.remove('active'); el.layoutCorners.classList.add('active'); } draw(); });

    bindPair(el.att, el.attNum, v=>{ state.alpha = v; draw(); });
    bindPair(el.refl, el.reflNum, v=>{ state.reflectance = v; draw(); });

    el.layoutCenter.addEventListener('click', ()=>{ state.layout='center'; el.layoutCenter.classList.add('active'); el.layoutCorners.classList.remove('active'); state.nLamps=1; syncPair(el.lamps, el.lampsNum, 1); draw(); });
    el.layoutCorners.addEventListener('click', ()=>{ state.layout='corners'; el.layoutCorners.classList.add('active'); el.layoutCenter.classList.remove('active'); draw(); });

    el.normalize.addEventListener('change', e=>{ state.normalize = e.target.checked; draw(); });

    // Click to move probe (coordinates in cm)
    el.cnv.addEventListener('click', (e)=>{
      const rect = el.cnv.getBoundingClientRect();
      const u = (e.clientX - rect.left) / rect.width;   // 0..1 along X
      const v = (e.clientY - rect.top) / rect.height;   // 0..1 along Y
      state.probe_cm.x = Math.max(0, Math.min(state.Lx_cm, u*state.Lx_cm));
      state.probe_cm.y = Math.max(0, Math.min(state.Ly_cm, v*state.Ly_cm));
      updateProbeReadout();
      draw();
    });

    function constrainProbe(){
      state.probe_cm.x = Math.min(state.probe_cm.x, state.Lx_cm);
      state.probe_cm.y = Math.min(state.probe_cm.y, state.Ly_cm);
    }

    // Canvas DPI + aspect handling (based on cm aspect)
    function resizeCanvasToAspect(){
      const dpr = window.devicePixelRatio || 1;
      const cssW = el.cnv.clientWidth || el.cnv.width;
      const aspect = (state.Ly_cm>0 && state.Lx_cm>0) ? (state.Ly_cm/state.Lx_cm) : 1;
      el.cnv.width = Math.round(cssW * dpr);
      el.cnv.height = Math.round(cssW * aspect * dpr);
    }
    window.addEventListener('resize', draw);

    function fitPlaneMax(){ el.plane.max = state.Lz_cm; el.planeNum.max = state.Lz_cm; if(state.plane_z_cm>state.Lz_cm){ state.plane_z_cm = state.Lz_cm; el.plane.value = state.Lz_cm; el.planeNum.value = state.Lz_cm; } }

    function init(){
      setWL(222);
      // Seed values into paired controls
      syncPair(el.flux, el.fluxNum, state.flux_mW);
      syncPair(el.duration, el.durationNum, state.duration_s);
      syncPair(el.lenX, el.lenXNum, state.Lx_cm);
      syncPair(el.lenY, el.lenYNum, state.Ly_cm);
      syncPair(el.lenZ, el.lenZNum, state.Lz_cm);
      syncPair(el.plane, el.planeNum, state.plane_z_cm);
      syncPair(el.lamps, el.lampsNum, state.nLamps);
      syncPair(el.att, el.attNum, state.alpha);
      syncPair(el.refl, el.reflNum, state.reflectance);
      fitPlaneMax();
      draw();
      updateIrrConv();
      updateDoseConv();
    }
    init();

    // === Converter helpers ===
    const irrToWm2 = {
      'W/m²': 1,
      'mW/m²': 1e-3,
      'μW/m²': 1e-6,
      'mW/cm²': 10,
      'μW/cm²': 1e-2,
    };
    const doseToJm2 = {
      'J/m²': 1,
      'mJ/m²': 1e-3,
      'J/cm²': 1e4,
      'mJ/cm²': 10,
      'μJ/cm²': 1e-2,
    };

    const irrUnits = Object.keys(irrToWm2);
    const doseUnits = Object.keys(doseToJm2);

    const irrVal = document.getElementById('irrVal');
    const irrUnit = document.getElementById('irrUnit');
    const irrOut = document.getElementById('irrOut');
    const doseVal = document.getElementById('doseVal');
    const doseUnit = document.getElementById('doseUnit');
    const doseOut = document.getElementById('doseOut');

    function fmtNice(v){
      const a = Math.abs(v);
      if((a>=0.001 && a<10000) || a===0) return Number(v).toFixed(4).replace(/0+$/,'').replace(/\.$/,'');
      return Number(v).toExponential(3);
    }

    function renderList(target, list){
      target.innerHTML = `<ul style="margin:0;padding-left:18px">${list.map(([u,val])=>`<li><span class="kbd">${u}</span> = <b>${fmtNice(val)}</b></li>`).join('')}</ul>`;
    }

    function updateIrrConv(){
      const v = parseFloat(irrVal.value); if(!isFinite(v)) return;
      const u = irrUnit.value; const base = v * irrToWm2[u]; // W/m²
      const rows = irrUnits.map(U=>[U, base/irrToWm2[U]]);
      renderList(irrOut, rows);
    }
    function updateDoseConv(){
      const v = parseFloat(doseVal.value); if(!isFinite(v)) return;
      const u = doseUnit.value; const base = v * doseToJm2[u]; // J/m²
      const rows = doseUnits.map(U=>[U, base/doseToJm2[U]]);
      renderList(doseOut, rows);
    }

    // Pull values from current app state
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id==='useProbeE'){
        const x = state.probe_cm.x, y = state.probe_cm.y, z = state.plane_z_cm;
        const E = irradianceAt(cm2m(x), cm2m(y), cm2m(z)); // mW/m²
        irrVal.value = (E); irrUnit.value = 'mW/m²'; updateIrrConv();
      }
      if(e.target && e.target.id==='usePlaneMeanE'){
        const {arr} = computeField(); let sum=0; for(const v of arr) sum+=v; const mean = sum/arr.length; // mW/m²
        irrVal.value = (mean); irrUnit.value = 'mW/m²'; updateIrrConv();
      }
      if(e.target && e.target.id==='useProbeD'){
        const x = state.probe_cm.x, y = state.probe_cm.y, z = state.plane_z_cm;
        const E = irradianceAt(cm2m(x), cm2m(y), cm2m(z)); // mW/m²
        const D_mJ_cm2 = (E * state.duration_s) / 10000.0;
        doseVal.value = D_mJ_cm2; doseUnit.value = 'mJ/cm²'; updateDoseConv();
      }
      if(e.target && e.target.id==='usePlaneMeanD'){
        const {arr} = computeField(); let sum=0; for(const v of arr) sum+=v; const mean = sum/arr.length; // mW/m²
        const D_mJ_cm2 = (mean * state.duration_s) / 10000.0;
        doseVal.value = D_mJ_cm2; doseUnit.value = 'mJ/cm²'; updateDoseConv();
      }
      if(e.target && e.target.id==='useChamberMeanD'){
        const Eavg = chamberMeanIrradiance();
        const D_mJ_cm2 = (Eavg * state.duration_s) / 10000.0;
        doseVal.value = D_mJ_cm2; doseUnit.value = 'mJ/cm²'; updateDoseConv();
      }
    });

    irrVal && irrVal.addEventListener('input', updateIrrConv);
    irrUnit && irrUnit.addEventListener('change', updateIrrConv);
    doseVal && doseVal.addEventListener('input', updateDoseConv);
    doseUnit && doseUnit.addEventListener('change', updateDoseConv);
  </script>
</body>
</html>
